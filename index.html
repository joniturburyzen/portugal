<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø Scotland Guide</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a2b3d; color: #fff; height: 100vh; overflow: hidden; touch-action: manipulation; }

#map { position: absolute; top: 0; left: 0; width: 100%; height: calc(100vh - 115px); }

#speech-bubble {
  position: fixed; bottom: 130px; left: 10px; max-width: 260px;
  background: white; color: #1a2b3d; padding: 12px 16px;
  border-radius: 16px; border-bottom-left-radius: 4px;
  font-size: 0.82rem; line-height: 1.5; font-style: italic;
  box-shadow: 0 4px 20px rgba(0,0,0,0.35); z-index: 900;
  opacity: 0; transform: translateY(8px);
  transition: opacity 0.3s, transform 0.3s; pointer-events: none;
}
#speech-bubble.visible { opacity: 1; transform: translateY(0); }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
#speech-bubble.loading::after { content:' ‚ñå'; animation: blink 0.8s infinite; }

#panel-info {
  position: fixed; right: 12px; top: 12px;
  background: white; color: #333; padding: 18px;
  border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.4);
  max-width: 300px; width: calc(100% - 24px); z-index: 950;
  transition: transform 0.3s; max-height: calc(100vh - 140px); overflow-y: auto;
}
#panel-info.hidden { transform: translateX(400px); }
#panel-info img { width:100%; height:160px; object-fit:cover; border-radius:8px; margin-bottom:10px; display:none; }
#panel-info h2 { margin-bottom:4px; color:#0f1a25; font-size:1.05rem; }
#panel-rating { color:#e87424; margin-bottom:8px; font-size:0.85rem; }
#panel-address, #panel-phone { margin-bottom:4px; font-size:0.82rem; }
#panel-website { display:none; margin:8px 0; color:#e87424; text-decoration:none; font-size:0.82rem; }
#panel-website:hover { text-decoration:underline; }
#panel-hours { font-size:0.82rem; margin-bottom:12px; }
#hamish-description {
  background:#f8f4ee; border-left:3px solid #e87424;
  padding:10px 12px; border-radius:0 8px 8px 0;
  font-size:0.8rem; color:#333; font-style:italic;
  margin-bottom:12px; line-height:1.5; min-height:36px;
}
#hamish-description.loading { color:#aaa; }
#route-btn { background:#2196F3; color:white; border:none; padding:9px; border-radius:8px; cursor:pointer; width:100%; font-weight:bold; font-size:0.88rem; }
#route-btn:hover { background:#1976D2; }
#close-panel { position:absolute; top:8px; right:10px; background:none; border:none; font-size:1.4rem; cursor:pointer; color:#666; }

#route-panel {
  position: fixed; bottom:125px; left:50%; transform:translateX(-50%);
  background:white; color:#333; padding:14px 20px; border-radius:10px;
  box-shadow:0 5px 25px rgba(0,0,0,0.4); z-index:950;
  max-width:380px; text-align:center; width:calc(100% - 40px);
}
#route-panel.hidden { display:none; }
#route-summary { margin:8px 0; font-weight:bold; color:#0f1a25; font-size:0.9rem; }
#open-gmaps { display:inline-block; background:#4CAF50; color:white; padding:7px 14px; border-radius:6px; text-decoration:none; margin-top:8px; font-size:0.82rem; }
#close-route { position:absolute; top:5px; right:8px; background:none; border:none; font-size:1.2rem; cursor:pointer; color:#666; }

#diary-btn {
  position:fixed; top:12px; right:12px;
  background:#0f1a25; border:2px solid #e87424; color:#e87424;
  width:42px; height:42px; border-radius:50%; cursor:pointer; font-size:1.1rem;
  z-index:960; box-shadow:0 2px 10px rgba(0,0,0,0.3);
  display:flex; align-items:center; justify-content:center; transition:all 0.2s;
}
#diary-btn:hover { background:#e87424; color:white; }

#diary-panel {
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(10,20,30,0.92); z-index:2000;
  display:flex; align-items:center; justify-content:center; padding:20px;
}
#diary-panel.hidden { display:none; }
#diary-content {
  background:#fdf8f0; color:#2a1a0a; border-radius:12px; padding:22px;
  max-width:460px; width:100%; max-height:78vh; overflow-y:auto; position:relative;
  font-family: Georgia, serif;
}
#diary-content h2 { color:#e87424; font-size:1.1rem; margin-bottom:14px; text-align:center; border-bottom:1px solid #e8d8b8; padding-bottom:10px; }
#diary-text { font-size:0.86rem; line-height:1.8; color:#3a2a10; white-space:pre-wrap; }
#diary-text.loading { color:#aaa; font-style:italic; }
#close-diary { position:absolute; top:10px; right:12px; background:none; border:none; font-size:1.4rem; cursor:pointer; color:#888; }
#generate-diary-btn { background:#e87424; color:white; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; width:100%; font-weight:bold; margin-top:14px; font-size:0.88rem; }

#conv-form {
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(10,20,30,0.88); z-index:2000;
  display:flex; align-items:flex-end; justify-content:center;
}
#conv-form.hidden { display:none; }
#conv-form-inner {
  background:#0f1a25; border-top:2px solid #e87424; border-radius:16px 16px 0 0;
  padding:18px; width:100%; max-width:480px;
  display:flex; flex-direction:column; gap:10px;
}
#conv-messages { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:8px; min-height:100px; max-height:260px; }
.conv-msg { padding:9px 13px; border-radius:12px; font-size:0.83rem; line-height:1.4; max-width:85%; }
.conv-msg.hamish { background:#1a2b3d; color:#e8d8b8; align-self:flex-start; border-bottom-left-radius:3px; font-style:italic; }
.conv-msg.user { background:#e87424; color:white; align-self:flex-end; border-bottom-right-radius:3px; }
#conv-input-row { display:flex; gap:7px; align-items:center; }
#conv-input { flex:1; background:#1a2b3d; border:1px solid #344d63; color:white; padding:9px 13px; border-radius:20px; font-size:0.83rem; outline:none; font-family:inherit; }
#conv-input:focus { border-color:#e87424; }
#conv-send { background:#e87424; border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:0.95rem; flex-shrink:0; }
#conv-close { background:none; border:1px solid #344d63; color:#8aa8c0; padding:6px 14px; border-radius:16px; cursor:pointer; font-size:0.78rem; align-self:flex-end; }

#hamish-bar {
  position:fixed; bottom:0; left:0; right:0; height:115px;
  background:#0f1a25; border-top:2px solid #e87424;
  display:flex; align-items:center; padding:0 10px 0 6px; gap:8px;
  z-index:1000; box-shadow:0 -4px 20px rgba(0,0,0,0.5);
}
#hamish-avatar-wrap {
  flex-shrink:0; width:66px; height:108px;
  position:relative; bottom:4px; cursor:pointer;
}
@keyframes breathe { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
@keyframes cough { 0%{transform:translateX(0) rotate(0deg)} 20%{transform:translateX(-5px) rotate(-2deg)} 40%{transform:translateX(5px) rotate(2deg)} 60%{transform:translateX(-3px) rotate(-1deg)} 80%{transform:translateX(2px)} 100%{transform:translateX(0) rotate(0deg)} }
#hamish-svg { animation:breathe 3.8s ease-in-out infinite; transform-origin:bottom center; width:66px; height:108px; }
#hamish-svg.coughing { animation:cough 0.55s ease-in-out; }

#cat-btns { display:flex; flex-direction:column; gap:5px; flex-shrink:0; }
.cat-btn { background:#1a2b3d; border:1.5px solid #344d63; color:#8aa8c0; padding:6px 10px; border-radius:18px; cursor:pointer; font-size:0.71rem; font-weight:bold; transition:all 0.2s; white-space:nowrap; }
.cat-btn:hover { border-color:#e87424; color:#e87424; }
.cat-btn.active { background:#e87424; border-color:#e87424; color:white; box-shadow:0 2px 8px rgba(232,116,36,0.4); }

.bar-sep { width:1px; height:68px; background:#1e3a50; flex-shrink:0; }

#bar-chat { flex:1; min-width:0; display:flex; flex-direction:column; gap:4px; }
#bar-status { font-size:0.68rem; color:#e87424; opacity:0.75; font-style:italic; min-height:13px; }
#bar-input-row { display:flex; gap:6px; align-items:center; }
#bar-input { flex:1; background:#1a2b3d; border:1px solid #344d63; color:white; padding:8px 11px; border-radius:20px; font-size:0.77rem; outline:none; font-family:inherit; min-width:0; }
#bar-input:focus { border-color:#e87424; }
#bar-input::placeholder { color:#4a6a80; }
#bar-send { background:#e87424; border:none; color:white; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:0.88rem; flex-shrink:0; }
#bar-send:hover { background:#ff914d; }
</style>
</head>
<body>

<div id="map"></div>
<div id="speech-bubble"></div>
<button id="diary-btn" title="Diario del d√≠a">üìì</button>

<div id="panel-info" class="hidden">
  <button id="close-panel">√ó</button>
  <img id="panel-photo" src="" alt="">
  <h2 id="panel-name"></h2>
  <div id="panel-rating"></div>
  <p id="panel-address"></p>
  <p id="panel-phone"></p>
  <a id="panel-website" target="_blank">üåê Web oficial</a>
  <div id="hamish-description">...</div>
  <p id="panel-hours"></p>
  <button id="route-btn">üß≠ CALCULAR RUTA</button>
</div>

<div id="route-panel" class="hidden">
  <button id="close-route">√ó</button>
  <h3 style="font-size:0.95rem">Ruta calculada</h3>
  <div id="route-summary"></div>
  <a id="open-gmaps" target="_blank">üì± Abrir en Google Maps</a>
</div>

<div id="diary-panel" class="hidden">
  <div id="diary-content">
    <button id="close-diary">√ó</button>
    <h2>üìì Diario del d√≠a</h2>
    <div id="diary-text">Pulsa el bot√≥n para que Hamish escriba el diario de hoy.</div>
    <button id="generate-diary-btn">‚úçÔ∏è Generar diario</button>
  </div>
</div>

<div id="conv-form" class="hidden">
  <div id="conv-form-inner">
    <div id="conv-messages"></div>
    <div id="conv-input-row">
      <input type="text" id="conv-input" placeholder="Escr√≠bele a Hamish...">
      <button id="conv-send">‚û§</button>
    </div>
    <button id="conv-close">Cancelar</button>
  </div>
</div>

<div id="hamish-bar">
  <div id="hamish-avatar-wrap">
    <svg id="hamish-svg" viewBox="0 0 240 400" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="85" cy="388" rx="28" ry="9" fill="#e8e8e0" stroke="#1a1a1a" stroke-width="2.5"/>
      <ellipse cx="148" cy="386" rx="24" ry="8" fill="#e8e8e0" stroke="#1a1a1a" stroke-width="2.5"/>
      <path d="M72,288 Q64,330 58,378 Q70,384 88,382 Q94,338 96,288Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2.5"/>
      <path d="M118,286 Q126,326 136,372 Q148,374 158,370 Q150,328 144,284Z" fill="#ddb888" stroke="#1a1a1a" stroke-width="2.5"/>
      <path d="M60,354 Q58,374 58,378 Q70,385 90,382 Q92,374 90,354Z" fill="#f5f5f0" stroke="#1a1a1a" stroke-width="2"/>
      <line x1="60" y1="360" x2="90" y2="359" stroke="#2d5a27" stroke-width="2.5"/>
      <line x1="60" y1="366" x2="90" y2="365" stroke="#2d5a27" stroke-width="2"/>
      <path d="M134,350 Q134,368 136,372 Q148,376 158,370 Q156,362 154,350Z" fill="#f5f5f0" stroke="#1a1a1a" stroke-width="2"/>
      <line x1="134" y1="356" x2="157" y2="356" stroke="#2d5a27" stroke-width="2.5"/>
      <line x1="135" y1="362" x2="157" y2="362" stroke="#2d5a27" stroke-width="2"/>
      <path d="M62,208 Q58,252 58,288 L152,286 Q152,250 148,208Z" fill="#2d5a27" stroke="#1a1a1a" stroke-width="3"/>
      <line x1="61" y1="222" x2="149" y2="222" stroke="#1a3a18" stroke-width="2.5"/>
      <line x1="61" y1="231" x2="149" y2="231" stroke="#c8400a" stroke-width="1.8" opacity="0.85"/>
      <line x1="60" y1="242" x2="149" y2="241" stroke="#1a3a18" stroke-width="2.5"/>
      <line x1="60" y1="251" x2="149" y2="250" stroke="#c8400a" stroke-width="1.8" opacity="0.85"/>
      <line x1="60" y1="262" x2="150" y2="261" stroke="#1a3a18" stroke-width="2.5"/>
      <line x1="59" y1="271" x2="150" y2="270" stroke="#c8400a" stroke-width="1.8" opacity="0.85"/>
      <line x1="59" y1="280" x2="151" y2="279" stroke="#1a3a18" stroke-width="2"/>
      <line x1="78" y1="208" x2="76" y2="288" stroke="#1a3a18" stroke-width="2"/>
      <line x1="88" y1="208" x2="86" y2="288" stroke="#c8400a" stroke-width="1.5" opacity="0.7"/>
      <line x1="103" y1="208" x2="102" y2="287" stroke="#1a3a18" stroke-width="2.5"/>
      <line x1="117" y1="208" x2="117" y2="287" stroke="#1a3a18" stroke-width="2.5"/>
      <line x1="128" y1="208" x2="129" y2="287" stroke="#c8400a" stroke-width="1.5" opacity="0.7"/>
      <line x1="140" y1="208" x2="142" y2="287" stroke="#1a3a18" stroke-width="2"/>
      <rect x="60" y="203" width="90" height="11" rx="4" fill="#3a2010" stroke="#1a1a1a" stroke-width="2.5"/>
      <rect x="99" y="200" width="12" height="17" rx="3" fill="#c8a855" stroke="#1a1a1a" stroke-width="2"/>
      <rect x="103" y="205" width="4" height="7" rx="1" fill="#3a2010"/>
      <g id="h-arms">
        <path d="M64,158 Q44,188 46,222 Q56,226 68,222 Q72,192 80,166Z" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="2.5"/>
        <path d="M46,218 Q42,230 44,240 Q54,244 68,240 Q70,228 68,220Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2.5"/>
        <path d="M146,158 Q162,185 166,216 Q156,220 146,218 Q140,188 134,166Z" fill="#162d4a" stroke="#1a1a1a" stroke-width="2"/>
        <path d="M166,212 Q170,224 168,234 Q158,238 146,234 Q144,222 146,216Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2"/>
      </g>
      <g id="h-jacket">
        <path d="M62,155 Q56,178 60,208 L150,208 Q154,178 148,155 Q126,144 105,144 Q84,144 62,155Z" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="3"/>
        <polygon points="105,154 86,177 96,154" fill="#f5f5f0" stroke="#1a1a1a" stroke-width="2"/>
        <polygon points="105,154 124,177 114,154" fill="#f5f5f0" stroke="#1a1a1a" stroke-width="2"/>
        <circle cx="105" cy="184" r="3.5" fill="#c8a855" stroke="#1a1a1a" stroke-width="1.5"/>
        <circle cx="105" cy="196" r="3.5" fill="#c8a855" stroke="#1a1a1a" stroke-width="1.5"/>
        <rect x="118" y="166" width="18" height="14" rx="2" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="1.5"/>
        <path d="M120,166 Q127,159 136,166" fill="white" stroke="#1a1a1a" stroke-width="1.5"/>
      </g>
      <path d="M92,130 Q105,126 118,130 L120,153 Q105,158 90,153Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2.5"/>
      <ellipse cx="106" cy="94" rx="50" ry="52" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="3.5"/>
      <ellipse cx="56" cy="98" rx="9" ry="11" fill="#ddb888" stroke="#1a1a1a" stroke-width="2.5"/>
      <ellipse cx="57" cy="98" rx="5" ry="7" fill="#c8a070"/>
      <ellipse cx="156" cy="96" rx="8" ry="10" fill="#ddb888" stroke="#1a1a1a" stroke-width="2"/>
      <path d="M74,76 Q86,69 98,74" stroke="#4a3010" stroke-width="6" fill="none" stroke-linecap="round"/>
      <path d="M116,73 Q128,68 140,74" stroke="#4a3010" stroke-width="6" fill="none" stroke-linecap="round"/>
      <path d="M101,72 Q105,66 109,72" stroke="#c09060" stroke-width="2.5" fill="none"/>
      <ellipse cx="87" cy="89" rx="11" ry="11" fill="white" stroke="#1a1a1a" stroke-width="2.5"/>
      <ellipse cx="125" cy="87" rx="10" ry="10" fill="white" stroke="#1a1a1a" stroke-width="2.5"/>
      <circle cx="88" cy="90" r="6" fill="#5a7a8a"/>
      <circle cx="126" cy="88" r="5.5" fill="#5a7a8a"/>
      <circle cx="88" cy="90" r="3.2" fill="#1a1a1a"/>
      <circle cx="126" cy="88" r="3" fill="#1a1a1a"/>
      <circle cx="90" cy="87" r="2" fill="white"/>
      <circle cx="128" cy="85" r="1.8" fill="white"/>
      <path d="M76,83 Q87,78 99,83" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="1.8"/>
      <path d="M115,81 Q125,76 136,81" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="1.8"/>
      <path d="M98,102 Q96,114 92,120 Q99,125 106,123 Q113,125 120,120 Q116,114 114,102Z" fill="#d4a882" stroke="#c09060" stroke-width="1.8"/>
      <circle cx="94" cy="119" r="5" fill="#c88060"/>
      <circle cx="118" cy="118" r="4.5" fill="#c88060"/>
      <path d="M90,133 Q106,128 122,133" stroke="#1a1a1a" stroke-width="3.5" fill="none" stroke-linecap="round"/>
      <path d="M90,135 Q87,140 88,145" stroke="#c8a070" stroke-width="1.8" fill="none"/>
      <path d="M122,134 Q125,139 124,144" stroke="#c8a070" stroke-width="1.8" fill="none"/>
      <ellipse cx="70" cy="112" rx="13" ry="9" fill="#e87424" opacity="0.22"/>
      <ellipse cx="142" cy="110" rx="12" ry="8" fill="#e87424" opacity="0.22"/>
      <path d="M58,108 Q56,136 64,156 Q78,170 106,172 Q134,170 148,156 Q156,136 154,108 Q140,122 106,126 Q72,122 58,108Z" fill="white" stroke="#1a1a1a" stroke-width="2.5"/>
      <path d="M68,116 Q66,136 68,152" stroke="#ddd" stroke-width="1.8" fill="none"/>
      <path d="M82,122 Q80,140 82,158" stroke="#ddd" stroke-width="1.8" fill="none"/>
      <path d="M106,126 Q104,144 106,166" stroke="#ddd" stroke-width="1.8" fill="none"/>
      <path d="M128,122 Q130,140 128,158" stroke="#ddd" stroke-width="1.8" fill="none"/>
      <path d="M144,116 Q146,136 142,152" stroke="#ddd" stroke-width="1.8" fill="none"/>
      <path d="M88,128 Q98,122 106,125 Q114,122 124,128 Q116,135 106,132 Q96,135 88,128Z" fill="#c8c8be" stroke="#aaa" stroke-width="1.5"/>
      <g id="h-hat">
        <ellipse cx="106" cy="48" rx="54" ry="13" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="3"/>
        <path d="M54,48 Q62,24 106,22 Q150,24 158,48Z" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="3"/>
        <ellipse cx="106" cy="48" rx="54" ry="13" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="2.5"/>
        <path d="M54,50 Q46,54 50,62 Q64,60 86,57 L88,48Z" fill="#162d4a" stroke="#1a1a1a" stroke-width="2.5"/>
        <path d="M55,50 Q106,44 157,50" stroke="#c8a855" stroke-width="1.5" fill="none" opacity="0.6"/>
      </g>
      <g id="h-acc">
        <rect x="156" y="222" width="18" height="22" rx="3" fill="#c8a855" opacity="0.8" stroke="#1a1a1a" stroke-width="2"/>
        <rect x="158" y="224" width="14" height="8" rx="2" fill="#e8d050" opacity="0.65"/>
        <rect x="156" y="242" width="18" height="4" rx="2" fill="#a08030" stroke="#1a1a1a" stroke-width="1.2"/>
      </g>
    </svg>
  </div>

  <div id="cat-btns">
    <button class="cat-btn active" data-cat="food">üçΩÔ∏è Jamar</button>
    <button class="cat-btn" data-cat="culture">üèõÔ∏è Culturilla</button>
    <button class="cat-btn" data-cat="nature">üå≤ Paseito</button>
  </div>

  <div class="bar-sep"></div>

  <div id="bar-chat">
    <div id="bar-status">Preg√∫ntale algo a Hamish...</div>
    <div id="bar-input-row">
      <input type="text" id="bar-input" placeholder="¬øQu√© recomiendas por aqu√≠?">
      <button id="bar-send">‚û§</button>
    </div>
  </div>
</div>

<script>
const GROK_URL = 'https://grokapi.joniturbu.workers.dev';

const SYSTEM = `Eres Hamish, gu√≠a escoc√©s de 60 a√±os. Gru√±√≥n pero con chispa y amor genuino por Escocia. 
Llevas toda la vida en las Highlands. Hablas en espa√±ol pero con giros propios: nunca dices "de acuerdo", dices "como quieras, ya te lo advert√≠".
Eres directo, a veces sarc√°stico, siempre honesto. Respuestas cortas, 2-4 frases m√°ximo.
Cuando describes lugares, priorizas informaci√≥n √∫til. Solo opinas cuando tienes base. Nunca tajante sin certeza.
El whisky es tu pasi√≥n y se nota.`;

const distilleries = [
  {name:"The Macallan",location:{lat:57.4638,lng:-3.1113},region:"Speyside",description:"Destiler√≠a de lujo, single malt premium.",founded:1824,website:"https://www.themacallan.com"},
  {name:"Glenfiddich",location:{lat:57.4494,lng:-3.1193},region:"Dufftown",description:"La m√°s visitada del mundo, pionera del single malt.",founded:1887,website:"https://www.glenfiddich.com"},
  {name:"The Glenlivet",location:{lat:57.3206,lng:-3.2322},region:"Ballindalloch",description:"Single malt suave y afrutado de Speyside.",founded:1824,website:"https://www.theglenlivet.com"},
  {name:"Lagavulin",location:{lat:55.6829,lng:-6.2258},region:"Islay",description:"Intenso, ahumado, turba. Culto entre aficionados.",founded:1816,website:"https://www.lagavulin.com"},
  {name:"Laphroaig",location:{lat:55.6839,lng:-6.2411},region:"Islay",description:"Sabor medicinal y ahumado. Car√°cter fuerte.",founded:1815,website:"https://www.laphroaig.com"},
  {name:"Ardbeg",location:{lat:55.6787,lng:-6.2667},region:"Islay",description:"Turba potente, notas de caf√© y chocolate.",founded:1815,website:"https://www.ardbeg.com"},
  {name:"Talisker",location:{lat:57.2894,lng:-6.3336},region:"Isle of Skye",description:"√önico de Skye. Marino, pimienta, humo.",founded:1830,website:"https://www.taliskerwhisky.com"},
  {name:"Highland Park",location:{lat:58.9808,lng:-2.9639},region:"Orkney",description:"El m√°s septentrional. Equilibrado, turba suave.",founded:1798,website:"https://www.highlandparkwhisky.com"},
  {name:"Springbank",location:{lat:55.4303,lng:-5.5964},region:"Campbeltown",description:"√öltimo basti√≥n tradicional de Campbeltown. 100% manual.",founded:1828,website:"https://www.springbankwhisky.com"}
];

const outfits = {
  food: {
    hat:`<ellipse cx="106" cy="48" rx="54" ry="13" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="3"/><path d="M54,48 Q62,24 106,22 Q150,24 158,48Z" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="3"/><ellipse cx="106" cy="48" rx="54" ry="13" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="2.5"/><path d="M54,50 Q46,54 50,62 Q64,60 86,57 L88,48Z" fill="#162d4a" stroke="#1a1a1a" stroke-width="2.5"/><path d="M55,50 Q106,44 157,50" stroke="#c8a855" stroke-width="1.5" fill="none" opacity="0.6"/>`,
    jacket:`<path d="M62,155 Q56,178 60,208 L150,208 Q154,178 148,155 Q126,144 105,144 Q84,144 62,155Z" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="3"/><polygon points="105,154 86,177 96,154" fill="#f5f5f0" stroke="#1a1a1a" stroke-width="2"/><polygon points="105,154 124,177 114,154" fill="#f5f5f0" stroke="#1a1a1a" stroke-width="2"/><circle cx="105" cy="184" r="3.5" fill="#c8a855" stroke="#1a1a1a" stroke-width="1.5"/><circle cx="105" cy="196" r="3.5" fill="#c8a855" stroke="#1a1a1a" stroke-width="1.5"/><rect x="118" y="166" width="18" height="14" rx="2" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="1.5"/><path d="M120,166 Q127,159 136,166" fill="white" stroke="#1a1a1a" stroke-width="1.5"/>`,
    arms:`<path d="M64,158 Q44,188 46,222 Q56,226 68,222 Q72,192 80,166Z" fill="#1e3a5f" stroke="#1a1a1a" stroke-width="2.5"/><path d="M46,218 Q42,230 44,240 Q54,244 68,240 Q70,228 68,220Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2.5"/><path d="M146,158 Q162,185 166,216 Q156,220 146,218 Q140,188 134,166Z" fill="#162d4a" stroke="#1a1a1a" stroke-width="2"/><path d="M166,212 Q170,224 168,234 Q158,238 146,234 Q144,222 146,216Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2"/>`,
    acc:`<rect x="156" y="222" width="18" height="22" rx="3" fill="#c8a855" opacity="0.8" stroke="#1a1a1a" stroke-width="2"/><rect x="158" y="224" width="14" height="8" rx="2" fill="#e8d050" opacity="0.65"/><rect x="156" y="242" width="18" height="4" rx="2" fill="#a08030" stroke="#1a1a1a" stroke-width="1.2"/>`
  },
  culture: {
    hat:`<ellipse cx="106" cy="52" rx="52" ry="12" fill="#8b6914" stroke="#1a1a1a" stroke-width="3"/><path d="M56,52 Q64,28 106,26 Q148,28 156,52Z" fill="#a07820" stroke="#1a1a1a" stroke-width="3"/><ellipse cx="106" cy="52" rx="52" ry="12" fill="#a07820" stroke="#1a1a1a" stroke-width="2.5"/><line x1="72" y1="39" x2="76" y2="52" stroke="#8b6914" stroke-width="2" opacity="0.7"/><line x1="88" y1="32" x2="90" y2="52" stroke="#8b6914" stroke-width="2" opacity="0.7"/><line x1="106" y1="28" x2="106" y2="52" stroke="#8b6914" stroke-width="2" opacity="0.7"/><line x1="122" y1="32" x2="120" y2="52" stroke="#8b6914" stroke-width="2" opacity="0.7"/><line x1="138" y1="39" x2="134" y2="52" stroke="#8b6914" stroke-width="2" opacity="0.7"/><path d="M54,54 Q46,58 50,66 Q64,64 84,61 L86,52Z" fill="#8b6914" stroke="#1a1a1a" stroke-width="2.5"/>`,
    jacket:`<path d="M62,155 Q56,178 60,208 L150,208 Q154,178 148,155 Q126,144 105,144 Q84,144 62,155Z" fill="#5a3e20" stroke="#1a1a1a" stroke-width="3"/><path d="M90,146 Q105,140 120,146 Q116,156 105,158 Q94,156 90,146Z" fill="#f5f5f0" stroke="#1a1a1a" stroke-width="2"/><ellipse cx="70" cy="186" rx="10" ry="12" fill="#4a3018" stroke="#1a1a1a" stroke-width="1.8"/><ellipse cx="140" cy="184" rx="10" ry="12" fill="#4a3018" stroke="#1a1a1a" stroke-width="1.8"/><circle cx="105" cy="175" r="3.5" fill="#c8a855" stroke="#1a1a1a" stroke-width="1.5"/><circle cx="105" cy="188" r="3.5" fill="#c8a855" stroke="#1a1a1a" stroke-width="1.5"/>`,
    arms:`<path d="M64,158 Q44,188 46,222 Q56,226 68,222 Q72,192 80,166Z" fill="#5a3e20" stroke="#1a1a1a" stroke-width="2.5"/><path d="M46,218 Q42,230 44,240 Q54,244 68,240 Q70,228 68,220Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2.5"/><path d="M146,158 Q162,185 166,216 Q156,220 146,218 Q140,188 134,166Z" fill="#4a3018" stroke="#1a1a1a" stroke-width="2"/><path d="M166,212 Q170,224 168,234 Q158,238 146,234 Q144,222 146,216Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2"/>`,
    acc:`<rect x="32" y="200" width="20" height="30" rx="2" fill="#8b1a1a" stroke="#1a1a1a" stroke-width="2.5"/><rect x="34" y="202" width="4" height="26" rx="1" fill="#6b1010"/><line x1="40" y1="208" x2="50" y2="208" stroke="#c8a855" stroke-width="1.3"/><line x1="40" y1="214" x2="50" y2="214" stroke="#c8a855" stroke-width="1.3"/><line x1="40" y1="220" x2="50" y2="220" stroke="#c8a855" stroke-width="1.3"/>`
  },
  nature: {
    hat:`<path d="M56,64 Q58,30 106,26 Q154,30 156,64Z" fill="#2d5a27" stroke="#1a1a1a" stroke-width="3"/><circle cx="106" cy="28" r="14" fill="#e87424" stroke="#1a1a1a" stroke-width="2.5"/><circle cx="103" cy="25" r="6" fill="#ff9944" opacity="0.55"/><rect x="54" y="58" width="96" height="14" rx="5" fill="#1a3a18" stroke="#1a1a1a" stroke-width="2.5"/><line x1="56" y1="64" x2="150" y2="64" stroke="#e87424" stroke-width="2.2" opacity="0.85"/>`,
    jacket:`<path d="M62,155 Q56,178 60,208 L150,208 Q154,178 148,155 Q126,144 105,144 Q84,144 62,155Z" fill="#2d5a27" stroke="#1a1a1a" stroke-width="3"/><line x1="105" y1="148" x2="105" y2="208" stroke="#1a3a18" stroke-width="3"/><rect x="101" y="158" width="8" height="12" rx="2" fill="#c8a855" stroke="#1a1a1a" stroke-width="1.5"/><rect x="66" y="174" width="24" height="18" rx="3" fill="#255020" stroke="#1a1a1a" stroke-width="1.5"/><rect x="120" y="174" width="24" height="18" rx="3" fill="#255020" stroke="#1a1a1a" stroke-width="1.5"/><path d="M74,148 Q105,140 136,148" fill="#255020" stroke="#1a1a1a" stroke-width="2"/>`,
    arms:`<path d="M64,158 Q44,188 46,222 Q56,226 68,222 Q72,192 80,166Z" fill="#2d5a27" stroke="#1a1a1a" stroke-width="2.5"/><path d="M46,218 Q42,230 44,240 Q54,244 68,240 Q70,228 68,220Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2.5"/><path d="M146,158 Q162,185 166,216 Q156,220 146,218 Q140,188 134,166Z" fill="#255020" stroke="#1a1a1a" stroke-width="2"/><path d="M166,212 Q170,224 168,234 Q158,238 146,234 Q144,222 146,216Z" fill="#e8c9a0" stroke="#1a1a1a" stroke-width="2"/>`,
    acc:`<line x1="168" y1="230" x2="174" y2="360" stroke="#5a3e20" stroke-width="5" stroke-linecap="round"/><path d="M160,230 Q168,220 176,230" fill="none" stroke="#3a2010" stroke-width="5" stroke-linecap="round"/>`
  }
};

// Estado
let map, userPosition=null, currentMarkers=[], customMarkers=[];
let infoWindow, directionsRenderer, directionsService, selectedPlace;
let currentCategory='food', tempCircle=null, bubbleTimer=null;
let visitedPlaces=[], convStep=0, convMarkerPos=null, convMarkerData={};

function applyOutfit(cat) {
  const o = outfits[cat];
  document.getElementById('h-hat').innerHTML    = o.hat;
  document.getElementById('h-jacket').innerHTML = o.jacket;
  document.getElementById('h-arms').innerHTML   = o.arms;
  document.getElementById('h-acc').innerHTML    = o.acc;
}

async function askGrok(msg, sys) {
  try {
    const r = await fetch(GROK_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'grok-3-mini', max_tokens:220,
        messages:[{role:'system',content:sys||SYSTEM},{role:'user',content:msg}]
      })
    });
    const d = await r.json();
    return d.choices?.[0]?.message?.content || 'Hmm. Sin palabras.';
  } catch(e) { return 'Las l√≠neas est√°n ca√≠das. Int√©ntalo luego.'; }
}

function showBubble(text, ms=6000) {
  const b = document.getElementById('speech-bubble');
  b.textContent = text; b.classList.remove('loading'); b.classList.add('visible');
  clearTimeout(bubbleTimer);
  if (ms>0) bubbleTimer = setTimeout(()=>b.classList.remove('visible'), ms);
}
function showBubbleLoading() {
  const b = document.getElementById('speech-bubble');
  b.textContent='Hamish est√° pensando'; b.classList.add('visible','loading');
  clearTimeout(bubbleTimer);
}

const spontaneous = {
  food:    ['Diez minutos mirando el mapa. ¬øPerdidos ya?','El whisky antes del desayuno. As√≠ se hace.','Aqu√≠ el caf√© es un insulto. Pedid t√©.'],
  culture: ['Mil a√±os de historia y vosotros mirando el m√≥vil.','Leed algo antes de entrar. Os lo pido por favor.','Bonnie Prince Charlie pas√≥ por aqu√≠. Huy√≥ mejor que vosotros.'],
  nature:  ['Ahora s√≠. El mapa pod√©is guardarlo.','Si llueve, Escocia os est√° probando.','Ese sendero tiene 500 a√±os. Vuestras zapatillas, dos.']
};
function showRandom() {
  const l = spontaneous[currentCategory];
  showBubble(l[Math.floor(Math.random()*l.length)], 5000);
}

window.initMap = function() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      p=>{ userPosition={lat:p.coords.latitude,lng:p.coords.longitude}; loadMap(); },
      ()=>{ userPosition={lat:55.9533,lng:-3.1883}; loadMap(); },
      {enableHighAccuracy:true,timeout:10000}
    );
  } else { userPosition={lat:55.9533,lng:-3.1883}; loadMap(); }
};

function loadMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center:userPosition, zoom:13,
    mapTypeControl:false, streetViewControl:false, fullscreenControl:false,
    styles:[
      {featureType:'water',elementType:'geometry',stylers:[{color:'#193341'}]},
      {featureType:'landscape',elementType:'geometry',stylers:[{color:'#2c5a3c'}]},
      {featureType:'road',elementType:'geometry',stylers:[{color:'#3a3a3a'}]},
      {featureType:'poi',elementType:'geometry',stylers:[{color:'#4a6a4a'}]}
    ]
  });
  infoWindow = new google.maps.InfoWindow({maxWidth:280});
  directionsService  = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    map, suppressMarkers:true,
    polylineOptions:{strokeColor:'#e87424',strokeWeight:5,strokeOpacity:0.8}
  });
  new google.maps.Marker({
    position:userPosition, map,
    icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:'#e87424',fillOpacity:1,strokeColor:'white',strokeWeight:2},
    title:'Tu ubicaci√≥n'
  });
  map.addListener('click', event=>{
    clearTempCircle();
    tempCircle = new google.maps.Circle({
      strokeColor:'#FF0000',strokeOpacity:0.8,strokeWeight:2,
      fillColor:'#FF0000',fillOpacity:0.35,
      map, center:event.latLng, radius:15, clickable:true
    });
    google.maps.event.addListener(tempCircle,'click',()=>{ startConvForm(event.latLng); clearTempCircle(); });
  });
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(p=>{
      userPosition={lat:p.coords.latitude,lng:p.coords.longitude};
      checkNearby();
    },null,{enableHighAccuracy:true});
  }
  loadDistilleries();
  loadCustomMarkers();
  setTimeout(()=>loadCategoryPlaces(),500);
  setTimeout(()=>showRandom(),2200);
  (function coughLoop(){
    setTimeout(()=>{ triggerCough(); coughLoop(); }, 55000+Math.random()*55000);
  })();
}

function triggerCough() {
  const s = document.getElementById('hamish-svg');
  s.classList.add('coughing');
  s.addEventListener('animationend',()=>s.classList.remove('coughing'),{once:true});
}

let lastNearby=0;
function checkNearby() {
  if (!userPosition || Date.now()-lastNearby<60000) return;
  const near = currentMarkers.find(m=>{
    const pos=m.getPosition(); if(!pos) return false;
    return google.maps.geometry.spherical.computeDistanceBetween(
      new google.maps.LatLng(userPosition.lat,userPosition.lng),pos
    ) < 150;
  });
  if (near) {
    lastNearby=Date.now();
    showBubbleLoading();
    askGrok(`El viajero est√° a menos de 150 metros de "${near.getTitle()}". Di algo breve sobre estar cerca. M√°ximo 2 frases.`).then(r=>showBubble(r,7000));
  }
}

document.querySelectorAll('.cat-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    clearTempCircle();
    document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentCategory=btn.dataset.cat;
    applyOutfit(currentCategory);
    loadCategoryPlaces();
    const msgs={food:['Ah, a comer.','El est√≥mago manda.'],culture:['Por fin cultura.','Mil a√±os os esperan.'],nature:['A lo que importa.','Las Highlands os esperan.']};
    const l=msgs[currentCategory];
    showBubble(l[Math.floor(Math.random()*l.length)],4000);
  });
});

function loadCategoryPlaces() {
  currentMarkers.forEach(m=>{ if(m.data&&m.data.type!=='distillery'&&m.data.type!=='custom') m.setMap(null); });
  currentMarkers=currentMarkers.filter(m=>m.data&&(m.data.type==='distillery'||m.data.type==='custom'));
  if(!userPosition) return;
  const svc=new google.maps.places.PlacesService(map);
  let req;
  if(currentCategory==='food')    req={location:userPosition,radius:5000,type:['restaurant','bar','cafe']};
  if(currentCategory==='culture') req={location:userPosition,radius:5000,type:['museum','art_gallery','church']};
  if(currentCategory==='nature')  req={location:userPosition,radius:5000,keyword:'hiking trail viewpoint nature park'};
  svc.nearbySearch(req,(results,status)=>{
    if(status===google.maps.places.PlacesServiceStatus.OK) results.forEach(p=>addPlaceMarker(p));
  });
}

function addPlaceMarker(place) {
  const colors={food:'red-dot',culture:'green-dot',nature:'blue-dot'};
  const marker=new google.maps.Marker({
    position:place.geometry.location, map,
    icon:{url:`http://maps.google.com/mapfiles/ms/icons/${colors[currentCategory]}.png`,scaledSize:new google.maps.Size(30,30)},
    title:place.name, data:{...place,type:'place',category:currentCategory}
  });
  google.maps.event.addListener(marker,'mouseover',()=>{
    let c=`<div style="font-family:Arial;padding:10px;min-width:160px"><h3 style="margin:0 0 4px">${place.name}</h3>`;
    if(place.rating) c+=`<div style="color:#e87424">${'‚≠ê'.repeat(Math.floor(place.rating))} ${place.rating}</div>`;
    if(place.vicinity) c+=`<p style="font-size:0.8rem;margin-top:4px">${place.vicinity}</p>`;
    infoWindow.setContent(c+'</div>'); infoWindow.open(map,marker);
  });
  google.maps.event.addListener(marker,'mouseout',()=>infoWindow.close());
  google.maps.event.addListener(marker,'click',()=>{
    clearTempCircle();
    new google.maps.places.PlacesService(map).getDetails({placeId:place.place_id},(d,s)=>{
      if(s===google.maps.places.PlacesServiceStatus.OK) showPlacePanel(d);
    });
  });
  currentMarkers.push(marker);
}

function loadDistilleries() {
  const icon={url:'https://cdn-icons-png.flaticon.com/512/190/190945.png',scaledSize:new google.maps.Size(32,32),anchor:new google.maps.Point(16,32)};
  distilleries.forEach(dist=>{
    const marker=new google.maps.Marker({position:dist.location,map,icon,title:dist.name,data:{...dist,type:'distillery'}});
    google.maps.event.addListener(marker,'mouseover',()=>{
      infoWindow.setContent(`<div style="font-family:Arial;padding:10px"><h3 style="color:#8B4513">ü•É ${dist.name}</h3><p style="font-size:0.82rem;color:#666">${dist.region} ¬∑ ${dist.founded}</p></div>`);
      infoWindow.open(map,marker);
    });
    google.maps.event.addListener(marker,'mouseout',()=>infoWindow.close());
    google.maps.event.addListener(marker,'click',()=>{ clearTempCircle(); showDistilleryPanel(dist); });
    currentMarkers.push(marker);
  });
}

function showPlacePanel(place) {
  document.getElementById('panel-name').textContent=place.name||'';
  const rEl=document.getElementById('panel-rating');
  rEl.innerHTML=place.rating?`${'‚≠ê'.repeat(Math.floor(place.rating))}${'‚òÜ'.repeat(5-Math.floor(place.rating))} ${place.rating}/5 ${place.user_ratings_total?`(${place.user_ratings_total})`:''}` :'';
  document.getElementById('panel-address').textContent=place.vicinity||place.formatted_address||'';
  const ph=document.getElementById('panel-phone');
  ph.innerHTML=place.international_phone_number?`üìû <a href="tel:${place.international_phone_number.replace(/\s/g,'')}">${place.international_phone_number}</a>`:'';
  const w=document.getElementById('panel-website');
  if(place.website){w.href=place.website;w.style.display='inline-block';}else w.style.display='none';
  const h=document.getElementById('panel-hours');
  h.innerHTML=place.opening_hours?.weekday_text?`<strong>Horario:</strong><br>${place.opening_hours.weekday_text.slice(0,3).join('<br>')}` :'';
  const ph2=document.getElementById('panel-photo');
  if(place.photos?.[0]){ph2.src=place.photos[0].getUrl({maxWidth:400,maxHeight:220});ph2.style.display='block';}else ph2.style.display='none';
  const desc=document.getElementById('hamish-description');
  desc.textContent='Hamish est√° pensando...'; desc.classList.add('loading');
  const rInfo=place.rating?`Rating ${place.rating}/5 con ${place.user_ratings_total||'?'} rese√±as`:'';
  askGrok(`El viajero ha seleccionado "${place.name}" (${place.vicinity||''}). ${rInfo}. Descripci√≥n breve y √∫til con tu estilo. M√°ximo 3 frases.`)
    .then(r=>{desc.textContent=r;desc.classList.remove('loading');});
  selectedPlace=place;
  document.getElementById('panel-info').classList.remove('hidden');
  if(!visitedPlaces.find(p=>p.name===place.name))
    visitedPlaces.push({name:place.name,category:currentCategory,time:new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})});
}

function showDistilleryPanel(dist) {
  document.getElementById('panel-name').textContent=`ü•É ${dist.name}`;
  document.getElementById('panel-rating').innerHTML=`<span style="color:#8B4513">${dist.region} ¬∑ ${dist.founded}</span>`;
  document.getElementById('panel-address').textContent=dist.region;
  document.getElementById('panel-phone').textContent='';
  const w=document.getElementById('panel-website');
  if(dist.website){w.href=dist.website;w.style.display='inline-block';}else w.style.display='none';
  document.getElementById('panel-hours').textContent='';
  document.getElementById('panel-photo').style.display='none';
  const desc=document.getElementById('hamish-description');
  desc.textContent='Hamish est√° pensando...'; desc.classList.add('loading');
  askGrok(`Destiler√≠a "${dist.name}", ${dist.region}, fundada ${dist.founded}. ${dist.description} Cuenta algo sobre este whisky con pasi√≥n. M√°ximo 3 frases.`)
    .then(r=>{desc.textContent=r;desc.classList.remove('loading');});
  selectedPlace={geometry:{location:new google.maps.LatLng(dist.location.lat,dist.location.lng)}};
  document.getElementById('panel-info').classList.remove('hidden');
  if(!visitedPlaces.find(p=>p.name===dist.name))
    visitedPlaces.push({name:dist.name,category:'whisky',time:new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})});
}

function showCustomMarkerPanel(data) {
  document.getElementById('panel-name').textContent=data.name;
  document.getElementById('panel-rating').innerHTML=`<span style="color:#e87424">üìç ${data.category}</span>`;
  document.getElementById('panel-address').textContent=`${data.position.lat.toFixed(4)}, ${data.position.lng.toFixed(4)}`;
  document.getElementById('panel-phone').textContent='';
  document.getElementById('panel-website').style.display='none';
  document.getElementById('panel-hours').textContent='';
  document.getElementById('panel-photo').style.display='none';
  const desc=document.getElementById('hamish-description');
  desc.textContent=data.description||'Tu marcador personal.'; desc.classList.remove('loading');
  selectedPlace={geometry:{location:new google.maps.LatLng(data.position.lat,data.position.lng)}};
  document.getElementById('panel-info').classList.remove('hidden');
}

function calculateRoute() {
  if(!selectedPlace||!userPosition) return;
  const dest=selectedPlace.geometry.location;
  directionsService.route({origin:userPosition,destination:dest,travelMode:google.maps.TravelMode.DRIVING},(res,status)=>{
    if(status===google.maps.DirectionsStatus.OK){
      directionsRenderer.setDirections(res);
      const leg=res.routes[0].legs[0];
      document.getElementById('route-summary').innerHTML=`üìç ${leg.distance.text} ¬∑ ‚è±Ô∏è ${leg.duration.text}`;
      const o=`${userPosition.lat},${userPosition.lng}`;
      const d=`${dest.lat()},${dest.lng()}`;
      document.getElementById('open-gmaps').href=`https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}&travelmode=driving`;
      document.getElementById('route-panel').classList.remove('hidden');
    }
  });
}

// Formulario conversacional
function startConvForm(latLng) {
  convMarkerPos=latLng; convMarkerData={}; convStep=0;
  document.getElementById('conv-messages').innerHTML='';
  document.getElementById('conv-form').classList.remove('hidden');
  addConvMsg('hamish','¬øQu√© encontraste aqu√≠? Cu√©ntame algo.');
}
function addConvMsg(who,text) {
  const d=document.createElement('div'); d.className=`conv-msg ${who}`; d.textContent=text;
  const msgs=document.getElementById('conv-messages'); msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight;
}
async function handleConvSend() {
  const inp=document.getElementById('conv-input'); const text=inp.value.trim(); if(!text) return;
  inp.value=''; addConvMsg('user',text);
  if(convStep===0) {
    const prompt=`El usuario quiere a√±adir un marcador en el mapa y dice: "${text}". Extrae nombre corto y descripci√≥n breve. Responde SOLO en JSON v√°lido sin markdown: {"name":"...","description":"...","category":"personal"}. Categor√≠a: personal, favorito o nota.`;
    addConvMsg('hamish','...');
    const res=await askGrok(prompt);
    document.getElementById('conv-messages').lastChild.remove();
    try {
      const json=JSON.parse(res.replace(/```json|```/g,'').trim());
      convMarkerData=json;
      addConvMsg('hamish',`Entendido. Lo guardo como "${json.name}". ¬øConfirmas?`);
      convStep=1;
    } catch(e) {
      convMarkerData={name:text.slice(0,40),description:text,category:'personal'};
      addConvMsg('hamish',`Lo guardo como "${convMarkerData.name}". ¬øConfirmas?`);
      convStep=1;
    }
  } else if(convStep===1) {
    const l=text.toLowerCase();
    if(l.includes('s√≠')||l.includes('si')||l.includes('ok')||l.includes('vale')||l.includes('confirm')||l.includes('claro')) {
      saveConvMarker(); addConvMsg('hamish','Marcador guardado. No pierdas el sitio.');
      setTimeout(()=>document.getElementById('conv-form').classList.add('hidden'),1800);
    } else {
      addConvMsg('hamish','¬øC√≥mo lo llamamos entonces?'); convStep=2;
    }
  } else if(convStep===2) {
    convMarkerData.name=text.slice(0,40); saveConvMarker();
    addConvMsg('hamish',`Guardado como "${convMarkerData.name}".`);
    setTimeout(()=>document.getElementById('conv-form').classList.add('hidden'),1800);
  }
}
function saveConvMarker() {
  const data={...convMarkerData,position:{lat:convMarkerPos.lat(),lng:convMarkerPos.lng()},type:'custom'};
  const marker=new google.maps.Marker({
    position:convMarkerPos, map,
    icon:{url:'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',scaledSize:new google.maps.Size(30,30)},
    title:data.name, data
  });
  google.maps.event.addListener(marker,'click',()=>showCustomMarkerPanel(data));
  customMarkers.push(marker); currentMarkers.push(marker);
  saveMarkersToStorage();
  visitedPlaces.push({name:data.name,category:'custom',time:new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})});
}
function saveMarkersToStorage() {
  localStorage.setItem('scotlandMarkers',JSON.stringify(
    customMarkers.map(m=>({name:m.data.name,description:m.data.description,category:m.data.category,position:{lat:m.getPosition().lat(),lng:m.getPosition().lng()}}))
  ));
}
function loadCustomMarkers() {
  const saved=localStorage.getItem('scotlandMarkers'); if(!saved) return;
  try {
    JSON.parse(saved).forEach(item=>{
      const marker=new google.maps.Marker({
        position:item.position, map,
        icon:{url:'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',scaledSize:new google.maps.Size(30,30)},
        title:item.name, data:{...item,type:'custom'}
      });
      google.maps.event.addListener(marker,'click',()=>showCustomMarkerPanel(item));
      customMarkers.push(marker); currentMarkers.push(marker);
    });
  } catch(e){}
}

// Diario
document.getElementById('diary-btn').addEventListener('click',()=>document.getElementById('diary-panel').classList.remove('hidden'));
document.getElementById('close-diary').addEventListener('click',()=>document.getElementById('diary-panel').classList.add('hidden'));
document.getElementById('generate-diary-btn').addEventListener('click',async()=>{
  const el=document.getElementById('diary-text');
  el.textContent='Hamish est√° escribiendo...'; el.classList.add('loading');
  const places=visitedPlaces.length>0
    ? visitedPlaces.map(p=>`${p.time} - ${p.name} (${p.category})`).join('\n')
    : 'No se han visitado lugares todav√≠a.';
  const res=await askGrok(`El viajero visit√≥ hoy:\n${places}\n\nEscribe una entrada de diario de 6-8 frases en tono de cr√≥nica escocesa con tu voz caracter√≠stica. Narra el d√≠a con emoci√≥n y algo de sarcasmo afectuoso.`);
  el.textContent=res; el.classList.remove('loading');
});

// Bar chat
async function sendBar() {
  const inp=document.getElementById('bar-input'); const text=inp.value.trim(); if(!text) return;
  inp.value='';
  document.getElementById('bar-status').textContent='Hamish est√° pensando...';
  showBubbleLoading();
  const ctx=userPosition?`El viajero est√° en Escocia (${userPosition.lat.toFixed(3)},${userPosition.lng.toFixed(3)}). Modo: ${currentCategory}.`:'';
  const res=await askGrok(`${ctx} Pregunta: "${text}"`);
  document.getElementById('bar-status').textContent='Preg√∫ntale algo a Hamish...';
  showBubble(res,8000);
}
document.getElementById('bar-send').addEventListener('click',sendBar);
document.getElementById('bar-input').addEventListener('keydown',e=>{if(e.key==='Enter')sendBar();});

// Eventos formulario conv
document.getElementById('conv-send').addEventListener('click',handleConvSend);
document.getElementById('conv-input').addEventListener('keydown',e=>{if(e.key==='Enter')handleConvSend();});
document.getElementById('conv-close').addEventListener('click',()=>{ document.getElementById('conv-form').classList.add('hidden'); clearTempCircle(); });

// Eventos panel
document.getElementById('close-panel').addEventListener('click',()=>{ document.getElementById('panel-info').classList.add('hidden'); clearTempCircle(); });
document.getElementById('close-route').addEventListener('click',()=>{ document.getElementById('route-panel').classList.add('hidden'); directionsRenderer.set('directions',null); });
document.getElementById('route-btn').addEventListener('click',calculateRoute);

// Click en Hamish
document.getElementById('hamish-avatar-wrap').addEventListener('click',()=>{
  showBubbleLoading();
  askGrok('Di algo breve e inesperado. Una observaci√≥n sobre Escocia, el tiempo o los turistas. M√°ximo 2 frases.').then(r=>showBubble(r,6000));
});

function clearTempCircle() { if(tempCircle){tempCircle.setMap(null);tempCircle=null;} }

applyOutfit('food');
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE0XidfuLtjrNgNenKnpqq6lq1F0CTYUs&libraries=places,geometry&callback=initMap"></script>
</body>
</html>
